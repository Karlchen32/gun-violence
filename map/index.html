<!DOCTYPE html>
<meta charset="utf-8">
<style>

.state {
  fill: #ccc;
}

.state-boundary {
  fill: none;
  stroke: #fff;
}

</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
<script src="d3.svg.legend.js"></script>
<script>

var width = 960,
    height = 960;

projection = d3.geo.albersUsa()
    .scale(1000)
    .translate([width / 2, 250]);

path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

d3.json("us.json", function(error, us) {
  if (error) throw error;

  var states = topojson.feature(us, us.objects.states);

  svg.append("path")
      .datum(states)
      .attr("class", "state")
      .attr("d", path);

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "state-boundary")
      .attr("d", path);

  d3.csv("../data/motherjones.csv", motherjones);
  d3.json("../data/heppler.json", heppler);
});

function motherjones(data) {

  motherJonesData = data;

  sizeScale = d3.scale.linear().domain([0,10]).range([0,10]).clamp(true)

  data.forEach(function (d) {
    d.node = {};
    d.node.lat = parseFloat(d.latitude);
    d.node.long = parseFloat(d.longitude);
    d.node.venue = d.Venue;
    d.node.killed = parseInt(d.Fatalities);
    d.node.injured = parseInt(d.Injured);
    d.node.gender = d.Gender;
    d.node.race = d.Race;
    d.node.weapons = d["Type of weapons"].split(";");
    d.node.legal = d["Weapons obtained legally"];
    d.node.mentalIllness = d["Prior signs of possible mental illness"];
    d.node.date = new Date(d["Date"]);
    d.node.name = d["Case"];
  });

  d3.select("svg").selectAll("g.incident")
  .data(data)
  .enter()
  .append("g")
  .attr("class", "incident")
  .attr("transform", function (d) {return "translate(" + projection([d.node.long,d.node.lat]).join(",") + ")"});

  d3.selectAll("g.incident")
  .append("circle")
  .attr("class", "injured")
  .attr("r", function(d) {return sizeScale(d.node.injured)})
  .style("fill", "#ff3333")
  .style("stroke", "none")
  .style("fill-opacity", .75)

  var arc = d3.svg.arc()
  .innerRadius(function (d) {return sizeScale(d.node.injured)})
  .outerRadius(function (d) {return sizeScale(d.node.injured) + sizeScale(d.node.killed)})
//  .startAngle(2.5)
//  .endAngle(-2.5)
  .startAngle(3.5)
  .endAngle(-3.5)

  var noteArc = d3.svg.arc()
  .innerRadius(function (d) {return sizeScale(d.node.injured)})
  .outerRadius(function (d) {return Math.max(1, sizeScale(d.node.injured) + sizeScale(d.node.killed) + 0)})
  .startAngle(2.5)
  .endAngle(3.8)

  d3.selectAll("g.incident")
  .append("path")
  .attr("class", "death")
  .attr("d", function (d) {return arc(d)})
  .style("fill", "#b30000")
  .style("fill-opacity", .75)
  .style("stroke", "black")
  .style("stroke-width", "1px")

/*  d3.selectAll("g.incident")
  .append("path")
  .attr("class", "note")
  .attr("d", function (d) {return noteArc(d)})
  .style("fill", "red")
  .style("fill-opacity", 0)
  .style("stroke", "black")
  .style("stroke-width", "1px")
  */

  options = ["venue", "gender", "race", "legal", "mentalIllness"]

  options = [{label: "Where do these things happen?", name: "venue"},
  {label: "Is it always men?", name: "gender"},
  {label: "Is the shooter always white?", name: "race"},
  {label: "Did they get the guns legally?", name: "legal"},
  {label: "Were they crazy?", name: "mentalIllness"}]

  d3.select("svg").selectAll("text.options")
    .data(options)
    .enter()
    .append("text")
    .attr("x", 400)
    .attr("y", function (d,i) {return 500 + (i * 35)})
    .text(function (d) {return d.label})
    .on("mouseover", highlight);

      d3.select("svg").append("g")
      .attr("class", "legendQuant")
      .attr("transform", "translate(650,500)")
      .style("opacity", 1);

}

//last one next one nearest one

function highlight(option) {

  d3.selectAll("text")
  .style("font-weight", 300)

  d3.select(this)
  .style("font-weight", 900);

  var thisoption = motherJonesData.map(function (d) {return d.node[option.name]});
  var uniques = d3.set(thisoption).values()
  var colors = d3.scale.category10().domain(uniques);

  d3.selectAll("path.note")
    .transition()
    .duration(1000)
    .style("fill-opacity", 1)
    .style("fill", function (d) {return colors(d.node[option.name])});

  d3.selectAll("path.death")
    .transition()
    .duration(1000)
    .style("fill-opacity", 1)
    .style("fill", function (d) {return colors(d.node[option.name])});

  d3.selectAll("circle.injured")
    .transition()
    .duration(1000)
    .style("fill-opacity", 1)
    .style("fill", function (d) {return colors(d.node[option.name])});


    var legend = d3.legend.color()
      .labelFormat(function (d) {return d})
      .shapeWidth(20)
      .shapeHeight(20)
      .scale(colors);

    d3.select("svg").select(".legendQuant")
      .call(legend);



}

function heppler(data) {
  console.log(data);
}

</script>
